var Body,Component,ContactListener,Go,Gos,Sprite,Vehicle,Wheel,animStep,animate,b2Body,b2BodyDef,b2CircleShape,b2DebugDraw,b2Dot,b2Fixture,b2FixtureDef,b2MassData,b2PolygonShape,b2RevoluteJointDef,b2Vec2,b2World,contactListener,context,createHouse,createVehicle,createWheel,filter,frequencyChange,go,gravity,init,initialised,key,loadAudioFile,loadedAudio,logSave,objStore,object,objects,onWindowResize,pause,physicsScale,playAudioFile,prefab,previousTime,removeSave,resources,save,source,stats,value,_i,_j,_len,_len1,__bind=function(a,b){return function(){return a.apply(b,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(a,b){function d(){this.constructor=a}for(var c in b)__hasProp.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};Go=function(){function a(a){this.prefabName=a}return a}(),Component=function(){function a(a){}return a.prototype.initialise=function(a){this.go=a},a.prototype.update=function(a){},a.prototype.toJSON=function(){},a.prototype.parse=function(a){},a}(),Sprite=function(){function a(a,b,c,d,e,f,g){var h;this.go=a,this.numFrames=c,this.absWidth=f,this.absHeight=g,this.onLoad=__bind(this.onLoad,this),h=THREE.ImageUtils.loadTexture(b,null,this.onLoad),this.spriteMat=new THREE.SpriteMaterial({map:h,color:16777215,useScreenCoordinates:!1,scaleByViewport:!0,depthTest:!1,opacity:.75,transparent:!0}),this.sprite=new THREE.Sprite(this.spriteMat),resources.scene.add(this.sprite)}return a.prototype.update=function(){return this.sprite.updateMatrix()},a.prototype.onLoad=function(a){return this.absWidth!=null&&this.absHeight!=null?this.sprite.scale.set(this.absWidth*physicsScale,this.absHeight*physicsScale,1):this.sprite.scale.set(Math.floor(a.image.width/this.numFrames),a.image.height,1)},a.prototype.parse=function(a){return this.spriteMat.uvOffset.set(a.uvOffset.x,a.uvOffset.y)},a.prototype.toJSON=function(){return{uvOffset:this.spriteMat.uvOffset}},a}(),Vehicle=function(a){function b(a){var b=this;this.go=a,this.wheels=[],this.driveWheels=[],this.brakingWheels=[],this.steeringJoints=[],this.handbrakeWheels=[],Mousetrap.bind("left",function(){return b.left=!0},"keydown"),Mousetrap.bind("left",function(){return b.left=!1},"keyup"),Mousetrap.bind("right",function(){return b.right=!0},"keydown"),Mousetrap.bind("right",function(){return b.right=!1},"keyup"),Mousetrap.bind("up",function(){return b.up=!0},"keydown"),Mousetrap.bind("up",function(){return b.up=!1},"keyup"),Mousetrap.bind("down",function(){return b.down=!0},"keydown"),Mousetrap.bind("down",function(){return b.down=!1},"keyup"),Mousetrap.bind("space",function(){return b.space=!0},"keydown"),Mousetrap.bind("space",function(){return b.space=!1},"keyup")}return __extends(b,a),b.prototype.initialise=function(){},b.prototype.addWheel=function(a,b){var c;return c=new b2RevoluteJointDef,c.bodyA=this.go.body.body,c.enableLimit=!0,c.lowerAngle=0,c.upperAngle=0,c.localAnchorB.SetZero(),this.wheels.push(a),c.bodyB=a.body.body,c.localAnchorA.Set(b.x,b.y),resources.world.CreateJoint(c)},b.prototype.beginContact=function(a){},b.prototype.endContact=function(a){},b.prototype.update=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p;b=0,f=!1,a=!1,this.up?(b=200,f=!0):this.down&&(a=!0,b=0,f=!0),n=this.driveWheels;for(h=0,k=n.length;h<k;h++)g=n[h],g.wheel.desiredSpeed=b,g.wheel.setSpeed=f,g.wheel.braking=a;e=!1,this.space&&(e=!0),o=this.handbrakeWheels;for(i=0,l=o.length;i<l;i++)g=o[i],g.wheel.handbrake=e;d=0,this.right?d=-0.6:this.left&&(d=.6),p=this.steeringJoints;for(j=0,m=p.length;j<m;j++)c=p[j],c.SetLimits(d,d);return resources.camera.position.x=this.go.body.body.GetPosition().x*window.physicsScale,resources.camera.position.y=this.go.body.body.GetPosition().y*window.physicsScale,this.updateAudio()},b.prototype.updateAudio=function(){var a;return a=this.driveWheels[0].wheel.getForwardVelocity().Length()/100,frequencyChange(440+this.driveWheels[0].wheel.getForwardVelocity().Length()/100*1e3),source.playbackRate.value=a},b.prototype.toJSON=function(){return{}},b}(Go),Wheel=function(){function a(a){this.go=a,this.maxLateralImpulse=3,this.desiredSpeed=0,this.setSpeed=!1,this.handbrake}return a.prototype.initialise=function(){return this.body=this.go.body.body},a.prototype.updateDrive=function(a){var b,c,d,e,f;f=200,b=this.body.GetWorldVector(new b2Vec2(0,1)),c=b2Dot(this.getForwardVelocity(),b),d=0;if(!this.setSpeed)return;if(this.desiredSpeed>c)d=f;else if(this.braking&&c>0)d=-50;else if(d>-0.1&&d<.1)return;return e=b,e.Multiply(d),a&&e.Multiply(.2),this.body.ApplyForce(e,this.body.GetWorldCenter())},a.prototype.getLateralVelocity=function(){var a;return a=this.body.GetWorldVector(new b2Vec2(1,0)),a.Multiply(b2Dot(a,this.body.GetLinearVelocity())),a},a.prototype.getForwardVelocity=function(){var a;return a=this.body.GetWorldVector(new b2Vec2(0,1)),a.Multiply(b2Dot(a,this.body.GetLinearVelocity())),a},a.prototype.update=function(){var a,b,c,d,e,f,g;return f=this.getLateralVelocity(),f.Multiply(this.body.GetMass()),f.NegativeSelf(),e=f,g=e.Length()>this.maxLateralImpulse||this.handbrake,g&&e.Multiply(this.maxLateralImpulse/e.Length()),this.handbrake&&e.Multiply(.5),this.body.ApplyImpulse(e,this.body.GetWorldCenter()),this.updateDrive(g),this.body.ApplyTorque(.1*this.body.GetInertia()*-this.body.GetAngularVelocity()),a=this.getForwardVelocity(),b=a.Length(),d=-0.01,c=a,c.Multiply(d),this.body.ApplyForce(c,this.body.GetWorldCenter())},a.prototype.toJSON=function(){return{}},a}(),b2Vec2=Box2D.Common.Math.b2Vec2,b2Dot=Box2D.Common.Math.b2Math.Dot,b2BodyDef=Box2D.Dynamics.b2BodyDef,b2Body=Box2D.Dynamics.b2Body,b2FixtureDef=Box2D.Dynamics.b2FixtureDef,b2Fixture=Box2D.Dynamics.b2Fixture,b2World=Box2D.Dynamics.b2World,b2MassData=Box2D.Collision.Shapes.b2MassData,b2PolygonShape=Box2D.Collision.Shapes.b2PolygonShape,b2CircleShape=Box2D.Collision.Shapes.b2CircleShape,b2DebugDraw=Box2D.Dynamics.b2DebugDraw,b2RevoluteJointDef=Box2D.Dynamics.Joints.b2RevoluteJointDef,ContactListener=function(){function a(){}return a.prototype.PreSolve=function(a,b){},a.prototype.PostSolve=function(a,b){},a.prototype.BeginContact=function(a){var b,c;return b=a.GetFixtureA().GetBody().GetUserData(),c=a.GetFixtureB().GetBody().GetUserData(),this.sendMessage(b,c,"beginContact"),this.sendMessage(c,b,"beginContact")},a.prototype.EndContact=function(a){var b,c;return b=a.GetFixtureA().GetBody().GetUserData(),c=a.GetFixtureB().GetBody().GetUserData(),this.sendMessage(b,c,"endContact"),this.sendMessage(c,b,"endContact")},a.prototype.sendMessage=function(a,b,c){var d,e,f;f=[];for(d in a){if(!__hasProp.call(a,d))continue;e=a[d],e[c]!=null?f.push(e[c](b)):f.push(void 0)}return f},a}(),Body=function(){function a(a,b,c,d,e){this.go=a,this.targetPosition=d,this.targetRotation=e,this.body=resources.world.CreateBody(b),this.body.CreateFixture(c),this.body.SetUserData(this.go)}return a.prototype.update=function(){this.targetPosition!=null&&(this.targetPosition.x=this.body.GetPosition().x*physicsScale,this.targetPosition.y=this.body.GetPosition().y*physicsScale);if(this.go.sprite!=null)return this.go.sprite.sprite.rotation=this.body.GetAngle()},a.prototype.toJSON=function(){return{position:this.body.GetPosition(),angle:this.body.GetAngle()}},a.prototype.parse=function(a){return this.body.SetPosition(a.position),this.body.SetAngle(a.angle)},a}(),initialised=!1,resources={},stats=new Stats,stats.setMode(0),stats.domElement.style.position="absolute",stats.domElement.style.left="0px",stats.domElement.style.top="0px",document.body.appendChild(stats.domElement),physicsScale=10,gravity=new b2Vec2(0,0),resources.world=new b2World(gravity,!0),contactListener=new ContactListener,resources.world.SetContactListener(contactListener),loadedAudio=!1,typeof AudioContext!="undefined"&&AudioContext!==null?context=new AudioContext:typeof webkitAudioContext!="undefined"&&webkitAudioContext!==null?context=new webkitAudioContext:context=0,filter=context.createBiquadFilter(),source=context.createBufferSource(),playAudioFile=function(a){return source.buffer=a,source.loop=!0,filter.type=0,filter.frequency.value=2440,source.connect(filter),filter.connect(context.destination),source.start(0)},loadAudioFile=function(a){var b;return b=new XMLHttpRequest,b.open("get","buzz.wav",!0),b.responseType="arraybuffer",b.onload=function(){return context.decodeAudioData(b.response,function(a){return playAudioFile(a)})},b.send()},frequencyChange=function(a){var b,c,d,e;return c=40,b=context.sampleRate/2,e=Math.log(b/c)/Math.LN2,d=Math.pow(2,e*(a-1)),filter.frequency.value=b*d},window.frequencyChange=frequencyChange,loadAudioFile(),Gos=[],createWheel=function(){var a,b,c;return c=new Go("Wheel"),c.sprite=new Sprite(this.go,"wheel.png",1,1,1,.2,.6),b=new b2FixtureDef,b.density=1,b.shape=new b2PolygonShape,b.shape.SetAsBox(.1,.3),a=new b2BodyDef,a.type=b2Body.b2_dynamicBody,c.body=new Body(c,a,b,c.sprite.sprite.position,c.sprite.sprite.rotation),c.wheel=new Wheel(c),Gos.push(c),c},createVehicle=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n,o;return i=new Go("Vehicle"),i.sprite=new Sprite(i,"car.png",1,1,1,6,5),i.vehicle=new Vehicle(i),o=3,j=6,d=new b2FixtureDef,d.density=.5,d.friction=0,d.isSensor=!0,d.shape=new b2PolygonShape,d.shape.SetAsBox(o*.5,j*.5),c=new b2BodyDef,c.type=b2Body.b2_dynamicBody,c.position.x=a,c.position.y=b,i.body=new Body(i,c,d,i.sprite.sprite.position,i.sprite.sprite.rotation),e=createWheel(),f=i.vehicle.addWheel(e,new b2Vec2(-o/2,j/2.1)),g=createWheel(),h=i.vehicle.addWheel(g,new b2Vec2(o/2,j/2.1)),k=createWheel(),l=i.vehicle.addWheel(k,new b2Vec2(-o/2,-j/2.1)),m=createWheel(),n=i.vehicle.addWheel(m,new b2Vec2(o/2,-j/2.1)),i.vehicle.driveWheels.push(k),i.vehicle.driveWheels.push(m),i.vehicle.brakingWheels.push(e),i.vehicle.brakingWheels.push(g),i.vehicle.brakingWheels.push(k),i.vehicle.brakingWheels.push(m),i.vehicle.handbrakeWheels.push(k),i.vehicle.handbrakeWheels.push(m),i.vehicle.steeringJoints.push(f),i.vehicle.steeringJoints.push(h),Gos.push(i),i},createHouse=function(a,b){var c,d,e,f,g,h,i,j,k,l;return e=new Go("House"),l=20,i=10,g=l*physicsScale,f=i*physicsScale,j=new THREE.MeshBasicMaterial({color:7829282,wireframe:!1}),h=new THREE.CubeGeometry(g,f,1),k=new THREE.Mesh(h,j),resources.scene.add(k),d=new b2FixtureDef,d.density=1,d.friction=0,d.shape=new b2PolygonShape,d.shape.SetAsBox(l*.5,i*.5),c=new b2BodyDef,c.type=b2Body.b2_staticBody,c.position.x=a,c.position.y=b,e.body=new Body(e,c,d,k.position,k.rotation),Gos.push(e),e},init=function(){var a,b,c,d,e,f,g;return b=document.createElement("div"),a=new THREE.OrthographicCamera(-400,400,400,-400,1,100),a.position.z=40,f=new THREE.Scene,e=new THREE.WebGLRenderer({antialias:!1}),e.setSize(window.innerWidth*.8,window.innerHeight*.8),resources.renderer=e,resources.scene=f,resources.camera=a,document.body.appendChild(e.domElement),c=!0,c&&(d=new google.maps.Map(b,{zoom:4,center:new google.maps.LatLng(10,0),disableDefaultUI:!0,keyboardShortcuts:!1,mapTypeId:google.maps.MapTypeId.SATELLITE}),g=new ThreejsLayer({map:d},{layer:function(){var a,b,c;return a=new THREE.Geometry,c=new THREE.Texture(generateSprite()),c.needsUpdate=!0,b=new THREE.ParticleBasicMaterial({size:20,map:c,opacity:.3,blending:THREE.AdditiveBlending,depthTest:!1,transparent:!0})}})),initialised=!0},pause=!1,window.togglePause=function(){return pause=!pause,save()},Mousetrap.bind("p",window.togglePause,"keydown"),onWindowResize=function(){return resources.camera.aspect=window.innerWidth/window.innerHeight,resources.camera.updateProjectionMatrix(),resources.renderer.setSize(window.innerWidth,window.innerHeight)},window.addEventListener("resize",onWindowResize,!1),save=function(){var a,b,c,d,e,f,g;d={};for(f=0,g=Gos.length;f<g;f++){a=Gos[f],c={prefab:a.prefab};for(b in a){if(!__hasProp.call(a,b))continue;e=a[b],e.toJSON!=null&&(c+=e.toJSON())}d+=c}return localStorage.setItem("objects",JSON.stringify(Gos)),localStorage.setItem("pause",pause),console.log(JSON.stringify(Gos))},logSave=function(){return console.log(localStorage.getItem("objects"))},Mousetrap.bind("l",logSave,"keydown"),removeSave=function(){return localStorage.removeItem("objects"),localStorage.removeItem("pause")},previousTime=0,animStep=function(a){return animate((a-previousTime)/1e3),previousTime=a,requestAnimationFrame(animStep)},animate=function(a){var b,c,d,e,f;stats.begin(),pause||(resources.world.Step(a,10,10),resources.world.ClearForces(),TWEEN.update(),removeSave());for(e=0,f=Gos.length;e<f;e++){b=Gos[e];for(c in b){if(!__hasProp.call(b,c))continue;d=b[c],d.update!=null&&d.update()}}return resources.renderer.render(resources.scene,resources.camera),resources.world.DrawDebugData(),stats.end()},init(),pause=localStorage.getItem("pause"),objStore=localStorage.getItem("objects");if(pause&&objStore!=null){console.log("Loading save..."),objects=JSON.parse(objStore);for(_i=0,_len=objects.length;_i<_len;_i++){object=objects[_i],prefab=object.prefab,go=void 0,prefab==="Vehicle"?go=createVehicle(0,0):prefab==="Wheel"?go=createWheel(0,0):go=createHouse(0,-10);for(key in object){if(!__hasProp.call(object,key))continue;value=object[key],go[key].parse!=null&&go[key].parse(value)}}}else createVehicle(0,10),createHouse(0,-10),createHouse(25,-10),createHouse(-25,-10);for(_j=0,_len1=Gos.length;_j<_len1;_j++){go=Gos[_j];for(key in go){if(!__hasProp.call(go,key))continue;value=go[key],go[key].initialise!=null&&go[key].initialise()}}animStep(0)